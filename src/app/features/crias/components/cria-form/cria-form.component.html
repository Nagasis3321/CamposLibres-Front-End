<form [formGroup]="criaForm" (ngSubmit)="onSubmit()" class="flex flex-col max-h-[85vh]">
  <!-- Contenedor principal con scroll vertical -->
  <div class="overflow-y-auto flex-grow pr-2 space-y-6">
    
    <!-- SECCIÓN 1: SELECCIONAR PADRES -->
    <fieldset class="p-4 border rounded-md">
      <div class="flex justify-between items-center mb-4">
        <legend class="px-2 font-semibold text-lg">1. Seleccionar Padres</legend>
        <div class="relative group">
          <span class="text-primary cursor-pointer font-bold text-xl">?</span>
          <div class="absolute bottom-full right-0 mb-2 w-64 bg-neutral-dark text-white text-xs rounded py-2 px-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10">
            Debe seleccionar al menos una madre o un padre para establecer la relación.
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Columna Izquierda: Búsqueda y Resultados -->
        <div class="flex flex-col space-y-2">
          <label class="text-sm font-medium">Buscar Animal (por caravana)</label>
          <div class="flex space-x-2">
            <input type="text" [formControl]="parentSearchControl" placeholder="Dejar vacío para ver todos" class="form-input w-full">
            <button type="button" (click)="buscarAnimales()" class="btn-secondary">Buscar</button>
          </div>
          <div class="h-48 overflow-y-auto border rounded-md p-1 space-y-1">
            <p *ngIf="searchResults.length === 0" class="text-xs text-center text-gray-400 p-2">No hay resultados.</p>
            <div *ngFor="let animal of searchResults" 
                 (click)="seleccionarParaAsignar(animal)"
                 class="p-2 rounded-md text-sm border-b flex justify-between items-center"
                 [ngClass]="{
                   'bg-blue-100': animalParaAsignar?.id === animal.id, 
                   'hover:bg-gray-100 cursor-pointer': animalParaAsignar?.id !== animal.id,
                   'opacity-50 cursor-not-allowed': madreSeleccionada?.id === animal.id || padreSeleccionado?.id === animal.id
                 }">
              <!-- MEJORA: Se muestra más información del animal -->
              <span class="truncate">
                <strong>{{ animal.caravana || 'S/C' }}</strong>
                <span class="text-xs text-gray-500"> ({{animal.tipoAnimal}}) - {{ animal.pelaje }}</span>
              </span>
              <span class="text-xs font-semibold text-primary flex-shrink-0 ml-2">{{ animalParaAsignar?.id === animal.id ? 'Seleccionado' : 'Seleccionar' }}</span>
            </div>
          </div>
        </div>

        <!-- Columna Derecha: Padres Seleccionados y Botón de Asignar -->
        <div class="flex flex-col space-y-2">
          <label class="text-sm font-medium">Padres Seleccionados</label>
          <div class="border rounded-md p-2 min-h-[120px] space-y-2 flex flex-col justify-center">
            <!-- MEJORA: Se muestra más información de la madre -->
            <div *ngIf="madreSeleccionada" class="p-2 bg-pink-100 text-pink-800 text-sm rounded-md flex justify-between items-center">
              <span><strong>Madre:</strong> {{ madreSeleccionada.caravana || 'S/C' }} <span class="font-normal text-xs">({{ madreSeleccionada.pelaje }})</span></span>
              <button type="button" (click)="removerParent('madre')" class="font-bold text-pink-600">&times;</button>
            </div>
            <!-- MEJORA: Se muestra más información del padre -->
            <div *ngIf="padreSeleccionado" class="p-2 bg-blue-100 text-blue-800 text-sm rounded-md flex justify-between items-center">
              <span><strong>Padre:</strong> {{ padreSeleccionado.caravana || 'S/C' }} <span class="font-normal text-xs">({{ padreSeleccionado.pelaje }})</span></span>
              <button type="button" (click)="removerParent('padre')" class="font-bold text-blue-600">&times;</button>
            </div>
            <p *ngIf="!madreSeleccionada && !padreSeleccionado" class="text-xs text-center text-gray-400">Seleccione un animal de la lista.</p>
          </div>
          <button type="button" (click)="asignarParent()" class="btn-primary w-full mt-2" [disabled]="!animalParaAsignar">
            Asignar {{ ['Vaca', 'Vaquilla', 'Ternera'].includes(animalParaAsignar?.tipoAnimal || '') ? 'Madre' : (['Toro', 'Novillo', 'Ternero'].includes(animalParaAsignar?.tipoAnimal || '') ? 'Padre' : '') }}
          </button>
        </div>
      </div>
    </fieldset>

    <!-- SECCIÓN 2: IDENTIFICAR CRÍA -->
    <fieldset class="p-4 border rounded-md" formGroupName="cria">
      <legend class="px-2 font-semibold text-lg">2. Identificar Cría</legend>
      <div class="flex rounded-md shadow-sm mt-2" role="group">
        <button type="button" (click)="setMode('select')" [ngClass]="mode === 'select' ? 'bg-primary text-white' : 'bg-white'" class="px-4 py-2 text-sm font-medium text-gray-900 border border-gray-200 rounded-l-lg hover:bg-gray-100 w-1/2">
          Seleccionar Existente
        </button>
        <button type="button" (click)="setMode('create')" [ngClass]="mode === 'create' ? 'bg-primary text-white' : 'bg-white'" class="px-4 py-2 text-sm font-medium text-gray-900 border border-gray-200 rounded-r-lg hover:bg-gray-100 w-1/2">
          Registrar Nueva Cría
        </button>
      </div>

      <div *ngIf="mode === 'create'" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
        <div>
          <label class="text-sm font-medium">Caravana (Opcional)</label>
          <input type="text" formControlName="caravana" class="mt-1 w-full border border-gray-300 rounded-md p-2">
        </div>
        <div>
          <label class="text-sm font-medium">Pelaje</label>
          <input type="text" formControlName="pelaje" list="pelajes-list-cria" class="mt-1 block w-full border border-gray-300 rounded-md p-2">
          <datalist id="pelajes-list-cria">
            <option *ngFor="let pelaje of pelajes" [value]="pelaje"></option>
          </datalist>
        </div>
        <div>
          <label class="text-sm font-medium">Sexo</label>
          <select formControlName="sexo" class="mt-1 w-full border border-gray-300 rounded-md p-2">
            <option>Hembra</option>
            <option>Macho</option>
          </select>
        </div>
        <div>
          <label class="text-sm font-medium">Fecha de Nacimiento</label>
          <input type="date" formControlName="fechaNacimiento" class="mt-1 w-full border border-gray-300 rounded-md p-2">
        </div>
      </div>

      <div *ngIf="mode === 'select'" class="mt-4">
        <label class="text-sm font-medium">Seleccionar Animal Existente como Cría</label>
        <select formControlName="existingCriaId" class="mt-1 w-full border border-gray-300 rounded-md p-2">
          <option [ngValue]="null" disabled>-- Elija un animal --</option>
          <!-- MEJORA: Se muestra más información en el desplegable -->
          <option *ngFor="let animal of todosLosAnimales" [value]="animal.id">
            Caravana: {{ animal.caravana || 'S/C' }} | Tipo: {{ animal.tipoAnimal }} | Pelaje: {{ animal.pelaje }}
          </option>
        </select>
      </div>
    </fieldset>
  </div>

  <!-- Botones de Acción -->
  <div class="flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-3 gap-2 pt-4 mt-auto flex-shrink-0">
    <button type="button" (click)="cancel.emit()" class="btn-secondary w-full sm:w-auto">Cancelar</button>
    <button type="submit" [disabled]="criaForm.invalid" class="btn-primary disabled:opacity-50 w-full sm:w-auto">Guardar Relación</button>
  </div>
</form>
